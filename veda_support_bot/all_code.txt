=== bot/__init__.py ===
# –ü—É—Å—Ç–æ–π —Ñ–∞–π–ª

=== bot/states.py ===
from aiogram.fsm.state import StatesGroup, State


class HelpFSM(StatesGroup):
    language = State()
    description = State()
    filial = State()

=== bot/services/__init__.py ===
# –ü—É—Å—Ç–æ–π —Ñ–∞–π–ª

=== bot/services/pyrus_service.py ===
from typing import Dict, Any
import httpx
from bot.config import settings
import logging

logger = logging.getLogger(__name__)


class PyrusService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Pyrus API"""
    
    def __init__(self):
        self.api_key = settings.PYRUS_API_KEY
        self.base_url = settings.PYRUS_API_URL
        self.headers = {
            "Authorization": f"Bearer {self.api_key}",
            "Content-Type": "application/json"
        }
    
    async def create_task(self, data: Dict[str, Any]) -> str | None:
        """–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É –≤ Pyrus"""
        try:
            async with httpx.AsyncClient() as client:
                response = await client.post(
                    f"{self.base_url}/tasks",
                    json=data,
                    headers=self.headers
                )
                
                if response.status_code == 200:
                    result = response.json()
                    task_id = result.get("task", {}).get("id")
                    if task_id:
                        logger.info(f"–ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞: {task_id}")
                        return str(task_id)
                    else:
                        logger.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID –∑–∞–¥–∞—á–∏")
                        return None
                else:
                    logger.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏: {response.status_code} - {response.text}")
                    return None
                    
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏: {e}")
            return None


pyrus_service = PyrusService()

=== bot/services/i18n_service.py ===
from bot.locales.translations import translations
from typing import Dict, Any


class I18nService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è –∏–Ω—Ç–µ—Ä–Ω–∞—Ü–∏–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏"""
    
    def __init__(self):
        self.translations = translations
    
    def get_text(self, key: str, language: str = "ru") -> str:
        """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç –ø–æ –∫–ª—é—á—É –∏ —è–∑—ã–∫—É"""
        lang_data = self.translations.get(language, self.translations.get("ru", {}))
        return lang_data.get(key, key)
    
    def format_text(self, key: str, language: str = "ru", **kwargs) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏"""
        text = self.get_text(key, language)
        return text.format(**kwargs)


i18n_service = I18nService()

=== bot/services/group_service.py ===
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, update, insert, delete
from typing import List, Optional
from bot.models.group import Group
from bot.models.filial import Filial
import logging

logger = logging.getLogger(__name__)


class GroupService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≥—Ä—É–ø–ø–∞–º–∏"""
    
    @staticmethod
    async def get_or_create_group(
        session: AsyncSession,
        group_id: int,
        group_name: str
    ) -> tuple[Group, bool]:
        """–ü–æ–ª—É—á–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É"""
        # –ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –≥—Ä—É–ø–ø—É
        result = await session.execute(
            select(Group).where(Group.group_id == group_id)
        )
        group = result.scalar_one_or_none()
        
        if group:
            # –û–±–Ω–æ–≤–∏—Ç—å –∏–º—è –≥—Ä—É–ø–ø—ã, –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
            if group.group_name != group_name:
                group.group_name = group_name
                await session.commit()
            return group, False
        
        # –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É
        group = Group(
            group_id=group_id,
            group_name=group_name
        )
        session.add(group)
        await session.commit()
        await session.refresh(group)
        
        logger.info(f"–°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –≥—Ä—É–ø–ø–∞: {group_name} ({group_id})")
        return group, True
    
    @staticmethod
    async def set_premium(session: AsyncSession, group_id: int, is_premium: bool) -> bool:
        """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–º–∏—É–º —Å—Ç–∞—Ç—É—Å –≥—Ä—É–ø–ø—ã"""
        result = await session.execute(
            update(Group)
            .where(Group.id == group_id)
            .values(is_premium=is_premium)
        )
        await session.commit()
        return result.rowcount > 0
    
    @staticmethod
    async def get_group(session: AsyncSession, group_id: int) -> Optional[Group]:
        """–ü–æ–ª—É—á–∏—Ç—å –≥—Ä—É–ø–ø—É –ø–æ ID"""
        result = await session.execute(
            select(Group).where(Group.group_id == group_id)
        )
        return result.scalar_one_or_none()
    
    @staticmethod
    async def get_filials(session: AsyncSession, group_id: int) -> List[Filial]:
        """–ü–æ–ª—É—á–∏—Ç—å —Ñ–∏–ª–∏–∞–ª—ã –≥—Ä—É–ø–ø—ã"""
        result = await session.execute(
            select(Filial).where(Filial.group_id == group_id)
        )
        return list(result.scalars().all())
    
    @staticmethod
    async def add_filial(session: AsyncSession, group_id: int, filial_name: str) -> Optional[Filial]:
        """–î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª–∏–∞–ª –≥—Ä—É–ø–ø–µ"""
        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –≥—Ä—É–ø–ø–∞
        group = await GroupService.get_group(session, group_id)
        if not group:
            return None
        
        # –°–æ–∑–¥–∞—Ç—å —Ñ–∏–ª–∏–∞–ª
        filial = Filial(
            group_id=group.id,
            name=filial_name
        )
        session.add(filial)
        await session.commit()
        await session.refresh(filial)
        
        # –û–±–Ω–æ–≤–∏—Ç—å —Ñ–ª–∞–≥ has_filials
        await session.execute(
            update(Group)
            .where(Group.id == group.id)
            .values(has_filials=True)
        )
        await session.commit()
        
        logger.info(f"–î–æ–±–∞–≤–ª–µ–Ω —Ñ–∏–ª–∏–∞–ª '{filial_name}' –∫ –≥—Ä—É–ø–ø–µ {group_id}")
        return filial

=== bot/models/__init__.py ===
# –ü—É—Å—Ç–æ–π —Ñ–∞–π–ª

=== bot/models/group.py ===
from __future__ import annotations

from sqlalchemy import Boolean, BigInteger, String, DateTime
from sqlalchemy.orm import Mapped, mapped_column, relationship
from sqlalchemy.sql import func
from datetime import datetime
from typing import List, TYPE_CHECKING
from bot.database import Base

if TYPE_CHECKING:
    from .filial import Filial


class Group(Base):
    __tablename__ = "groups"

    id: Mapped[int] = mapped_column(primary_key=True)
    group_id: Mapped[int] = mapped_column(BigInteger, unique=True, index=True)
    group_name: Mapped[str] = mapped_column(String(255))
    is_premium: Mapped[bool] = mapped_column(Boolean, default=False)
    has_filials: Mapped[bool] = mapped_column(Boolean, default=False)
    created_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        server_default=func.now()
    )
    updated_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        server_default=func.now(),
        onupdate=func.now()
    )

    filials: Mapped[List["Filial"]] = relationship(
        "Filial",
        back_populates="group",
        cascade="all, delete-orphan"
    )

    def __repr__(self) -> str:
        return f"<Group {self.group_name}>"

=== bot/models/filial.py ===
from __future__ import annotations

from sqlalchemy import ForeignKey, String, DateTime
from sqlalchemy.orm import Mapped, mapped_column, relationship
from sqlalchemy.sql import func
from datetime import datetime
from typing import TYPE_CHECKING
from bot.database import Base

if TYPE_CHECKING:
    from .group import Group


class Filial(Base):
    __tablename__ = "filials"

    id: Mapped[int] = mapped_column(primary_key=True)
    group_id: Mapped[int] = mapped_column(
        ForeignKey("groups.id", ondelete="CASCADE"),
        index=True
    )
    name: Mapped[str] = mapped_column(String(255))
    pyrus_field_id: Mapped[str | None] = mapped_column(String(100), nullable=True)
    created_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        server_default=func.now()
    )

    group: Mapped["Group"] = relationship("Group", back_populates="filials")
    
    def __repr__(self) -> str:
        return f"<Filial {self.name}>"

=== bot/middlewares/__init__.py ===
# –ü—É—Å—Ç–æ–π —Ñ–∞–π–ª

=== bot/middlewares/language.py ===
"""
Middleware –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —è–∑—ã–∫–∞ –∏–∑ FSM
–ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º, –æ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–Ω–µ–¥—Ä—è–µ—Ç—Å—è –≤–æ –≤—Å–µ handlers
"""

from typing import Callable, Dict, Any, Awaitable
from aiogram import BaseMiddleware
from aiogram.types import TelegramObject
from aiogram.fsm.context import FSMContext


class LanguageMiddleware(BaseMiddleware):
    """Middleware –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —è–∑—ã–∫–∞ –∏–∑ FSM"""
    
    async def __call__(
        self,
        handler: Callable[[TelegramObject, Dict[str, Any]], Awaitable[Any]], 
        event: TelegramObject,
        data: Dict[str, Any]
    ) -> Any:
        # –ü–æ–ª—É—á–∞–µ–º state
        state: FSMContext | None = data.get("state")
        
        # –Ø–∑—ã–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        language = "ru"
        
        # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —è–∑—ã–∫ –∏–∑ FSM
        if state:
            state_data = await state.get_data()
            language = state_data.get("language", "ru")
        
        # –í–Ω–µ–¥—Ä—è–µ–º —è–∑—ã–∫ –≤ data –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ handlers
        data["language"] = language
        
        return await handler(event, data)

=== bot/middlewares/db.py ===
from typing import Callable, Dict, Any, Awaitable
from aiogram import BaseMiddleware
from aiogram.types import TelegramObject
from sqlalchemy.ext.asyncio import AsyncSession
from bot.database import db


class DatabaseMiddleware(BaseMiddleware):
    """Middleware –¥–ª—è –≤–Ω–µ–¥—Ä–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ –ë–î"""
    
    async def __call__(
        self,
        handler: Callable[[TelegramObject, Dict[str, Any]], Awaitable[Any]], 
        event: TelegramObject,
        data: Dict[str, Any]
    ) -> Any:
        async for session in db.get_session():
            data["session"] = session
            return await handler(event, data)

=== bot/middlewares/admin.py ===
from typing import Callable, Dict, Any, Awaitable
from aiogram import BaseMiddleware
from aiogram.types import Message
from bot.config import settings


class AdminMiddleware(BaseMiddleware):
    """Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    
    async def __call__(
        self,
        handler: Callable[[Message, Dict[str, Any]], Awaitable[Any]], 
        event: Message,
        data: Dict[str, Any]
    ) -> Any:
        if event.from_user is None:
            await event.answer("‚ùå –û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return
        
        if event.from_user.id not in settings.admin_ids_list:
            await event.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞")
            return
        
        return await handler(event, data)

=== bot/main.py ===
import asyncio
import logging
from aiogram import Bot, Dispatcher
from aiogram.client.default import DefaultBotProperties
from bot.config import settings
from bot.database import db
from bot.middlewares.db import DatabaseMiddleware
from bot.middlewares.language import LanguageMiddleware
from bot.handlers import router
import sys

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=getattr(logging, settings.LOG_LEVEL.upper()),
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.StreamHandler(sys.stdout),
        logging.FileHandler('bot.log', encoding='utf-8')
    ]
)

logger = logging.getLogger(__name__)


async def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    logger.info("–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞...")
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
    bot = Bot(
        token=settings.BOT_TOKEN,
        default=DefaultBotProperties(parse_mode="HTML")
    )
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
    dp = Dispatcher()
    
    # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ middleware
    dp.update.middleware(DatabaseMiddleware())
    dp.update.middleware(LanguageMiddleware())
    
    # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–æ—É—Ç–µ—Ä–æ–≤
    dp.include_router(router)
    
    # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –ë–î
    await db.create_tables()
    
    logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!")
    
    # –ó–∞–ø—É—Å–∫ polling
    await dp.start_polling(bot)


if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        logger.info("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        sys.exit(1)

=== bot/locales/__init__.py ===
# –ü—É—Å—Ç–æ–π —Ñ–∞–π–ª

=== bot/locales/translations.py ===
translations = {
    "ru": {
        "welcome": "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!",
        "choose_language": "–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫:",
        "enter_description": "–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É:",
        "choose_filial": "–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª–∏–∞–ª:",
        "request_created": "–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!",
        "error": "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞"
    },
    "uz": {
        "welcome": "Xush kelibsiz!",
        "choose_language": "Tilni tanlang:",
        "enter_description": "Muammoni tavsiflang:",
        "choose_filial": "Filialni tanlang:",
        "request_created": "Murojaat yaratildi!",
        "error": "Xatolik yuz berdi"
    },
    "en": {
        "welcome": "Welcome!",
        "choose_language": "Choose language:",
        "enter_description": "Describe the problem:",
        "choose_filial": "Choose branch:",
        "request_created": "Request created!",
        "error": "An error occurred"
    }
}

=== bot/keyboards/__init__.py ===
# –ü—É—Å—Ç–æ–π —Ñ–∞–π–ª

=== bot/keyboards/language.py ===
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton


def language_keyboard() -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞"""
    keyboard = [
        [
            InlineKeyboardButton(text="üá∑üá∫ –†—É—Å—Å–∫–∏–π", callback_data="lang_ru"),
            InlineKeyboardButton(text="üá∫üáø O'zbek", callback_data="lang_uz"),
            InlineKeyboardButton(text="üá∫üá∏ English", callback_data="lang_en")
        ]
    ]
    return InlineKeyboardMarkup(inline_keyboard=keyboard)

=== bot/keyboards/filials.py ===
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from typing import List
from bot.models.filial import Filial


def filials_keyboard(filials: List[Filial]) -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∏–ª–∏–∞–ª–∞"""
    keyboard = []
    
    for filial in filials:
        keyboard.append([
            InlineKeyboardButton(
                text=filial.name,
                callback_data=f"filial_{filial.id}"
            )
        ])
    
    return InlineKeyboardMarkup(inline_keyboard=keyboard)

=== bot/handlers/__init__.py ===
from . import admin, group_events, help_flow

__all__ = ["admin", "group_events", "help_flow"]

=== bot/handlers/admin.py ===
from aiogram import Router
from aiogram.filters import Command
from aiogram.types import Message
from sqlalchemy.ext.asyncio import AsyncSession
from bot.services.group_service import GroupService
from bot.middlewares.admin import AdminMiddleware
import logging

logger = logging.getLogger(__name__)
router = Router()
router.message.middleware(AdminMiddleware())


@router.message(Command("admin_set_premium"))
async def set_premium(message: Message, session: AsyncSession):
    """
    –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–º–∏—É–º —Å—Ç–∞—Ç—É—Å –≥—Ä—É–ø–ø—ã
    –§–æ—Ä–º–∞—Ç: /admin_set_premium <group_id> <true/false>
    """
    assert message.text is not None  # –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ –∫–æ–º–∞–Ω–¥–æ–π
    try:
        args = message.text.split()
        if len(args) != 3:
            await message.answer(
                "‚ö†Ô∏è –§–æ—Ä–º–∞—Ç: /admin_set_premium <group_id> <true/false>"
            )
            return
        
        group_id = int(args[1])
        is_premium = args[2].lower() == "true"
        
        success = await GroupService.set_premium(session, group_id, is_premium)
        
        if success:
            await message.answer(
                f"‚úÖ –ü—Ä–µ–º–∏—É–º —Å—Ç–∞—Ç—É—Å –¥–ª—è –≥—Ä—É–ø–ø—ã {group_id}: {is_premium}"
            )
        else:
            await message.answer(f"‚ùå –ì—Ä—É–ø–ø–∞ {group_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
            
    except ValueError:
        await message.answer("‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π group_id")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–µ–º–∏—É–º: {e}")
        await message.answer(f"‚ùå –û—à–∏–±–∫–∞: {e}")


@router.message(Command("admin_add_filial"))
async def add_filial(message: Message, session: AsyncSession):
    """
    –î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª–∏–∞–ª –≥—Ä—É–ø–ø–µ
    –§–æ—Ä–º–∞—Ç: /admin_add_filial <group_id> <–Ω–∞–∑–≤–∞–Ω–∏–µ>
    """
    assert message.text is not None  # –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ –∫–æ–º–∞–Ω–¥–æ–π
    try:
        args = message.text.split(maxsplit=2)
        if len(args) != 3:
            await message.answer(
                "‚ö†Ô∏è –§–æ—Ä–º–∞—Ç: /admin_add_filial <group_id> <–Ω–∞–∑–≤–∞–Ω–∏–µ>"
            )
            return
        
        group_id = int(args[1])
        filial_name = args[2]
        
        filial = await GroupService.add_filial(session, group_id, filial_name)
        
        if filial:
            await message.answer(
                f"‚úÖ –§–∏–ª–∏–∞–ª '{filial_name}' –¥–æ–±–∞–≤–ª–µ–Ω –≥—Ä—É–ø–ø–µ {group_id}"
            )
        else:
            await message.answer(f"‚ùå –ì—Ä—É–ø–ø–∞ {group_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
            
    except ValueError:
        await message.answer("‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π group_id")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–∏–ª–∏–∞–ª–∞: {e}")
        await message.answer(f"‚ùå –û—à–∏–±–∫–∞: {e}")

=== bot/handlers/group_events.py ===
from aiogram import Router, F
from aiogram.types import ChatMemberUpdated
from aiogram.filters import IS_MEMBER, IS_NOT_MEMBER, ChatMemberUpdatedFilter
from sqlalchemy.ext.asyncio import AsyncSession  # type: ignore
from bot.services.group_service import GroupService
import logging

logger = logging.getLogger(__name__)
router = Router()


@router.chat_member(
    ChatMemberUpdatedFilter(
        member_status_changed=IS_NOT_MEMBER >> IS_MEMBER
    )
)
async def on_bot_added(event: ChatMemberUpdated, session: AsyncSession):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É"""
    assert event.bot is not None  # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –±–æ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
    
    if not event.new_chat_member.user.is_bot:
        return
    
    try:
        group, created = await GroupService.get_or_create_group(
            session,
            event.chat.id,
            event.chat.title or "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –≥—Ä—É–ø–ø–∞"
        )
        
        welcome_text = (
            "üëã <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</b>\n\n"
            "–Ø –±–æ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∫–æ–º–ø–∞–Ω–∏–∏ VedaVector.\n\n"
            "<b>–ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É:</b>\n"
            "1. –ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É /help\n"
            "2. –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫\n"
            "3. –û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É\n\n"
            "‚ö†Ô∏è <i>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω—è–π—Ç–µ –∑–∞—è–≤–∫—É –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ</i>"
        )
        
        msg = await event.bot.send_message(
            event.chat.id,
            welcome_text,
            parse_mode="HTML"
        )
        
        # –ó–∞–∫—Ä–µ–ø–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ (–º–æ–∂–µ—Ç –Ω–µ –±—ã—Ç—å –ø—Ä–∞–≤)
        try:
            await event.bot.pin_chat_message(event.chat.id, msg.message_id)
        except Exception as e:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–∫—Ä–µ–ø–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}")
        
        logger.info(f"–ë–æ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≥—Ä—É–ø–ø—É: {event.chat.title} ({event.chat.id})")
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É: {e}")

=== bot/handlers/help_flow.py ===
from aiogram import Router, F
from aiogram.filters import Command, StateFilter
from aiogram.types import Message, CallbackQuery, InaccessibleMessage
from aiogram.fsm.context import FSMContext
from sqlalchemy.ext.asyncio import AsyncSession
from bot.states import HelpFSM
from bot.keyboards.language import language_keyboard
from bot.keyboards.filials import filials_keyboard
from bot.services.group_service import GroupService
from bot.services.pyrus_service import pyrus_service
from bot.config import settings
import logging

logger = logging.getLogger(__name__)
router = Router()


@router.message(Command("help"))
async def start_help(message: Message, state: FSMContext):
    """–ù–∞—á–∞–ª–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏"""
    if message.chat.type == "private":
        await message.answer(
            "‚ö†Ô∏è –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö"
        )
        return
    
    await state.set_state(HelpFSM.language)
    await message.answer(
        "üåê <b>–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ / Tilni tanlang / Choose language:</b>",
        reply_markup=language_keyboard(),
        parse_mode="HTML"
    )


@router.callback_query(F.data == "cancel")
async def cancel_help(call: CallbackQuery, state: FSMContext):
    """–û—Ç–º–µ–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏"""
    if call.message is None or isinstance(call.message, InaccessibleMessage):
        return
    await state.clear()
    await call.message.delete()
    await call.answer("‚ùå –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ –æ—Ç–º–µ–Ω–µ–Ω–æ")


@router.callback_query(HelpFSM.language, F.data.startswith("lang_"))
async def choose_language(
    call: CallbackQuery,
    state: FSMContext,
    session: AsyncSession
):
    """–í—ã–±–æ—Ä —è–∑—ã–∫–∞"""
    if call.message is None or isinstance(call.message, InaccessibleMessage) or call.data is None:
        return
    language = call.data.split("_")[1]
    await state.update_data(language=language)
    
    lang_messages = {
        "ru": "üìù –û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É –ø–æ–¥—Ä–æ–±–Ω–æ:",
        "uz": "üìù Muammoingizni batafsil tasvirlab bering:",
        "en": "üìù Describe your problem in detail:"
    }
    
    await call.message.edit_text(
        lang_messages.get(language, lang_messages["ru"])
    )
    await state.set_state(HelpFSM.description)
    await call.answer()


@router.message(HelpFSM.description, F.text)
async def get_description(
    message: Message,
    state: FSMContext,
    session: AsyncSession
):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã"""
    assert message.text is not None  # –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ —Ñ–∏–ª—å—Ç—Ä–æ–º F.text
    description = message.text.strip()
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è
    if len(description) < 10:
        await message.answer(
            "‚ö†Ô∏è –û–ø–∏—Å–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É –ø–æ–¥—Ä–æ–±–Ω–µ–µ."
        )
        return
    
    if len(description) > settings.MAX_DESCRIPTION_LENGTH:
        await message.answer(
            f"‚ö†Ô∏è –û–ø–∏—Å–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–º–∞–∫—Å–∏–º—É–º {settings.MAX_DESCRIPTION_LENGTH} —Å–∏–º–≤–æ–ª–æ–≤)"
        )
        return
    
    await state.update_data(description=description)
    
    # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏
    try:
        await message.delete()
    except Exception as e:
        logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∏–ª–∏–∞–ª–æ–≤
    group = await GroupService.get_group(session, message.chat.id)
    
    if not group:
        await message.answer("‚ùå –û—à–∏–±–∫–∞: –≥—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö")
        await state.clear()
        return
    
    if group.has_filials:
        filials = await GroupService.get_filials(session, message.chat.id)
        
        if filials:
            await message.answer(
                "üè¢ –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª–∏–∞–ª:",
                reply_markup=filials_keyboard(filials)
            )
            await state.set_state(HelpFSM.filial)
        else:
            await send_to_pyrus(message.bot, message.chat.id, state, session, group)
    else:
        await send_to_pyrus(message.bot, message.chat.id, state, session, group)


@router.callback_query(HelpFSM.filial, F.data.startswith("filial_"))
async def choose_filial(
    call: CallbackQuery,
    state: FSMContext,
    session: AsyncSession
):
    """–í—ã–±–æ—Ä —Ñ–∏–ª–∏–∞–ª–∞"""
    if call.message is None or isinstance(call.message, InaccessibleMessage) or call.data is None:
        return
    filial_id = int(call.data.split("_")[1])
    
    # –ü–æ–ª—É—á–∞–µ–º —Ñ–∏–ª–∏–∞–ª
    from bot.models.filial import Filial
    from sqlalchemy import select
    
    result = await session.execute(
        select(Filial).where(Filial.id == filial_id)
    )
    filial = result.scalar_one_or_none()
    
    if not filial:
        await call.answer("‚ùå –§–∏–ª–∏–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return
    
    await state.update_data(filial=filial.name)
    
    # –ü–æ–ª—É—á–∞–µ–º –≥—Ä—É–ø–ø—É
    group = await GroupService.get_group(session, call.message.chat.id)
    
    await call.message.delete()
    await send_to_pyrus(call.bot, call.message.chat.id, state, session, group)
    await call.answer()


async def send_to_pyrus(
    bot,
    chat_id: int,
    state: FSMContext,
    session: AsyncSession,
    group
):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞—è–≤–∫–∏ –≤ Pyrus"""
    data = await state.get_data()
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è Pyrus
    pyrus_data = {
        "description": data["description"],
        "language": data["language"],
        "group_name": group.group_name,
        "is_premium": group.is_premium,
        "filial": data.get("filial")
    }
    
    # –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á—É
    task_id = await pyrus_service.create_task(pyrus_data)
    
    if task_id:
        success_messages = {
            "ru": (
                "‚úÖ <b>–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!</b>\n\n"
                f"–ù–æ–º–µ—Ä –∑–∞—è–≤–∫–∏: <code>{task_id}</code>\n"
                "–ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è."
            ),
            "uz": (
                "‚úÖ <b>Murojaat muvaffaqiyatli yaratildi!</b>\n\n"
                f"Murojaat raqami: <code>{task_id}</code>\n"
                "Yaqin orada siz bilan bog'lanamiz."
            ),
            "en": (
                "‚úÖ <b>Request created successfully!</b>\n\n"
                f"Request ID: <code>{task_id}</code>\n"
                "We will contact you soon."
            )
        }
        
        msg_text = success_messages.get(data["language"], success_messages["ru"])
        await bot.send_message(chat_id, msg_text, parse_mode="HTML")
    else:
        await bot.send_message(
            chat_id,
            "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        )
    
    await state.clear()

=== bot/database.py ===
from sqlalchemy.ext.asyncio import (
    create_async_engine,
    async_sessionmaker,
    AsyncSession,
    AsyncEngine
)
from sqlalchemy.orm import DeclarativeBase
from typing import AsyncGenerator
import logging
from bot.config import settings

logger = logging.getLogger(__name__)


class Base(DeclarativeBase):
    pass


class Database:
    def __init__(self, url: str):
        self.engine: AsyncEngine = create_async_engine(
            url,
            echo=False,
            pool_pre_ping=True,
            pool_size=10,
            max_overflow=20
        )
        self.session_maker = async_sessionmaker(
            self.engine,
            class_=AsyncSession,
            expire_on_commit=False
        )
    
    async def create_tables(self):
        """–°–æ–∑–¥–∞—Ç—å –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã"""
        async with self.engine.begin() as conn:
            await conn.run_sync(Base.metadata.create_all)
            logger.info("–¢–∞–±–ª–∏—Ü—ã –ë–î —Å–æ–∑–¥–∞–Ω—ã")
    
    async def get_session(self) -> AsyncGenerator[AsyncSession, None]:
        """–ü–æ–ª—É—á–∏—Ç—å —Å–µ—Å—Å–∏—é –ë–î"""
        async with self.session_maker() as session:
            try:
                yield session
            except Exception as e:
                await session.rollback()
                logger.error(f"–û—à–∏–±–∫–∞ —Å–µ—Å—Å–∏–∏ –ë–î: {e}")
                raise
            finally:
                await session.close()


db = Database(settings.DATABASE_URL)

=== bot/config.py ===
from pydantic_settings import BaseSettings, SettingsConfigDict
from typing import List


class Settings(BaseSettings):
    model_config = SettingsConfigDict(
        env_file='.env',
        env_file_encoding='utf-8',
        extra='ignore'
    )
    
    # Telegram
    BOT_TOKEN: str
    ADMIN_IDS: str
    
    # Pyrus
    PYRUS_API_KEY: str
    PYRUS_API_URL: str = "https://api.pyrus.com/v4"
    
    # Database
    DATABASE_URL: str
    
    # Redis
    REDIS_URL: str = "redis://localhost:6379"
    
    # App
    LOG_LEVEL: str = "INFO"
    ENVIRONMENT: str = "production"
    MAX_DESCRIPTION_LENGTH: int = 1000
    
    @property
    def admin_ids_list(self) -> List[int]:
        return [int(id.strip()) for id in self.ADMIN_IDS.split(',')]


settings = Settings()  # type: ignore